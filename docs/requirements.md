# Lunch Hub 要件定義

## 1. このアプリの目的

### 学習目的
- Antigravityの学習
- DDDの学習
- TypeScriptの学習
- 一からWebアプリを作る学習

### ビジネス目的
- 社内の弁当注文プロセスを効率化
- 予約の可視化と管理の簡素化
- 係の負担軽減

---

## 2. 現状の運用と課題

### 2.1 現状の運用
- 社内のチャットツールで「明日お弁当を注文したい人」を当番が募集
- 食べたい人はチャットに絵文字リアクションで意思表示
- 当日、係の人がお弁当屋さんに電話注文
- 社内メンバ以外でもゲストのために注文することがある
- 支払いは係が集金(現金またはチケット)
- チケットは10枚綴りで現金払い、電話注文時に購入意思を伝える

### 2.2 課題
- 注文したかが絵文字チャットでは分かりづらい
- 係の人が毎日チャットで注文を確認する手間
- 当日キャンセルや変更がしづらい
- チャットツールは社内ネットワーク用のPCからしかアクセスできない

### 2.3 目指す状態
- Webアプリからお弁当の予約を簡単にできる
- カレンダー画面から注文を確認できる
- 翌月末までの注文を予約できる
- 予約を変更・キャンセルできる
- 社内メンバのみがアクセスできる

---

## 3. 機能要件

### 3.1 認証・認可

#### ユーザー登録（セルフサインアップ）
- ユーザーが自らメールアドレスと「社員用共通PIN」を入力して登録申請を行う
- 社員用共通PIN（環境変数で設定）が一致した場合のみ、招待メールを自動送信
- 招待メールに有効期限付きリンク(48時間)を含める
- 初期登録時の役割は自動的に `GENERAL_USER` となる（管理者が後から変更可能）

#### アカウントアクティベーション
- 招待リンクから初回パスワードを設定
- パスワードポリシー: 最低8文字、英数字と記号を含む
- アクティベーション完了後、即座にログイン可能

#### ログイン・ログアウト
- メールアドレスとパスワードでログイン
- ログイン失敗時のレート制限(10回/15分)
- セッション管理(アクセストークン: 15分、リフレッシュトークン: 7日)
- ログアウト時にセッションを無効化

#### パスワード管理
- ログイン後、パスワード変更が可能
- パスワード忘れた場合のリセット機能
- リセットリンクの有効期限(1時間)
- パスワード変更後、全セッションを無効化

#### アクセス制御
- 一般ユーザー: 自分の予約のみ管理
- 係: 全ユーザーの予約確認・管理、ゲスト予約作成
- 管理者: 係の権限 + ユーザー管理

---

### 3.2 弁当予約

#### 予約作成
- カレンダーから日付を選択
- 支払い方法を選択(現金 or チケット)
- チケット払いの場合、利用可能なチケットから選択
- 予約可能期間: 現在日〜翌月末
- 締め切り: 当日9:30まで

#### 予約変更
- 自分の予約を変更可能
- 締め切り前のみ変更可能
- 支払い方法の変更も可能

#### 予約キャンセル
- 自分の予約をキャンセル可能
- 締め切り前のみキャンセル可能
- チケット払いの場合、チケットの残高が1増える
- 9:30以降は自動的に変更・キャンセル不可

#### 予約確認
- 自分の予約一覧を表示
- カレンダー表示で視覚的に確認
- 予約の詳細(日付、支払い方法、ステータス)を表示

---

### 3.3 チケット管理

#### チケット購入予約
- チケット購入予約を作成(セット数を指定、1セット=10枚)
- 購入予約と同時に「予約中」状態のチケットが作成される
- 予約中のチケットでも弁当予約に使用可能

#### チケット受取確認
- 係が手動でチケット受取を確認
- ステータスを「PENDING」→「RECEIVED」に変更
- 安全性のため、係の承認が必要

#### 弁当予約とチケット購入の同時予約
- 1つの操作でチケット購入予約と弁当予約を同時に作成
- チケット購入予約 → チケット作成(残高10) → 弁当予約(残高9)の順で処理

---

### 3.4 注文管理(係・管理者)

#### 予約一覧確認
- 全ユーザーの予約を日付別に確認
- フィルター機能(日付、ユーザー、ステータス)
- 予約総数の表示

#### 注文集計
- 特定日の予約を集計
- 現金払い・チケット払いの内訳を表示
- チケット購入予約の一覧を表示

#### 注文確定
- **9:30で自動的に締め切り**(係の手動操作不要)
- 締め切り後、その日の予約は自動的に変更・キャンセル不可
- 注文履歴の保存は任意機能(Phase 2以降)

#### 他ユーザーの予約管理
- 他ユーザーの予約を変更・キャンセル可能
- 締め切り前のみ

---

### 3.5 ゲスト予約(係・管理者)

#### ゲスト作成
- ゲスト名のみ入力(訪問日は予約日と同じ)
- 係が代理で作成

#### ゲスト予約作成
- ゲストのために弁当予約を作成
- 支払い方法は現金固定(一時的な購入のため)
- 係が代理で管理

#### ゲスト予約の管理
- ゲスト予約の変更・キャンセルが可能
- 締め切り前のみ
- 予約履歴は不要(一時的なデータ)

---

### 3.6 ユーザー管理(管理者)

#### ユーザー招待
- メールアドレスと役割を指定して招待
- 招待メールを自動送信

#### ユーザー一覧
- 全ユーザーの一覧を表示
- フィルター機能(役割、ステータス)

#### ユーザー無効化・再有効化
- ユーザーを無効化(ログイン不可、ステータス: DEACTIVATED)
- 無効化されたユーザーを再有効化(ステータス: ACTIVE)

#### 役割変更
- ユーザーの役割を変更(GENERAL_USER ↔ STAFF ↔ ADMINISTRATOR)

---

## 4. 非機能要件

### 4.1 セキュリティ

#### 認証・認可
- パスワードはbcryptでハッシュ化(cost factor: 12)
- JWTトークンによるセッション管理
- HTTP-only cookieでリフレッシュトークンを管理
- CSRF対策の実装

#### レート制限とロックアウト
- ログイン試行: 10回/15分
- 10回失敗したユーザーは15分間ロックアウト(一律拒否)
- 15分経過で自動解除。管理者による手動解除機能は設けない。

#### 通信
- 本番環境ではHTTPS必須
- CORS設定(フロントエンドのオリジンのみ許可)

#### 入力検証
- 全てのユーザー入力をバリデーション
- SQLインジェクション対策(ORM使用)
- XSS対策(サニタイゼーション)

---

### 4.2 パフォーマンス

#### 応答時間
- ログイン処理: 2秒以内
- API応答: 1秒以内(通常時)
- ページ読み込み: 3秒以内
- 大人数での利用ではないため、基本的な最適化のみ実施

#### データベース
- 適切なインデックス設定
- N+1問題の回避
- コネクションプーリング

#### キャッシュ
- Redisでセッション管理
- 頻繁にアクセスされるデータのキャッシュ

---

### 4.3 可用性

#### 稼働時間
- ベストエフォート(できる限り動かす)
- 学習目的のため、厳密な可用性要件は設定しない
- 夜間メンテナンスでのダウンタイムは許容

#### ログ記録
- 認証に関わる全操作（ログイン、招待、アクティベーション）を30日間保持
- データの変更を伴う操作（予約作成、チケット購入）を7日間保持
- システムエラーの痕跡を30日間保持

---

### 4.4 保守性

#### コード品質
- DDDの原則に従った設計
- クリーンアーキテクチャの適用
- 単体テスト、統合テスト、E2Eテストの実装

#### ドキュメント
- 要件定義
- ユビキタス言語
- ドメインモデル
- アーキテクチャ設計
- API仕様
- セットアップ手順

---

### 4.5 データ管理

#### データ保持
- ユーザー情報: 無期限(無効化されたユーザーも保持)
- 予約履歴: 1週間程度(過去の履歴を見る需要は少ない)
- 注文履歴: 1週間程度
- チケット情報: 無期限(残高管理のため)

#### バックアップ
- データベースの定期バックアップ(本番環境)

---

### 4.6 UI/UX

#### レスポンシブデザイン
- **スマートフォンメイン**(モバイルファースト)
- デスクトップ、タブレットでも利用可能

#### アクセシビリティ
- 最低限の対応(基本的なHTML構造を守る)
- 社内メンバーのみの利用のため、厳密な要件は設定しない

#### 多言語対応
- 日本語のみ(多言語対応は不要)

#### ユーザビリティ
- 直感的なUI
- 適切なフィードバック(ローディング、成功・エラーメッセージ)
- カレンダーUIで視覚的に予約を確認

---

## 5. 技術要件

### 5.1 技術スタック

#### Backend
- Framework: NestJS 10.x
- Language: TypeScript 5.x
- Database: PostgreSQL 15.x
- Cache/Session: Redis 7.x
- ORM: TypeORM 0.3.x
- Authentication: JWT
- Password Hashing: bcrypt
- Email: Nodemailer(開発) / SendGrid(本番)
- Testing: Jest

#### Frontend
- Framework: React 18.x
- Language: TypeScript 5.x
- Build Tool: Vite
- State Management: Zustand
- HTTP Client: Axios
- Routing: React Router v6
- Form Handling: React Hook Form
- Validation: Zod
- Testing: Vitest, React Testing Library

#### DevOps
- Container: Docker, Docker Compose
- CI/CD: GitHub Actions
- Deployment: 未定(AWS、GCP、Azureなど)

---

### 5.2 開発環境

#### ローカル開発
- Docker Compose: PostgreSQL + Redis
- Node.js: 直接インストール
- アプリケーション: ローカルで実行

#### バージョン管理
- Git + GitHub

---

## 6. 制約事項

### 6.1 技術的制約
- メール送信機能が必要(SMTP設定またはメール送信サービス)
- 初期管理者アカウントはシードデータで作成
- 同一メールアドレスでの重複登録は不可

### 6.2 ビジネス的制約
- 社内メンバーのみがアクセス可能(招待制)
- 弁当の価格や種類の管理は対象外(固定)
- 決済機能は対象外(現金・チケットの記録のみ)
- 利用規模: ユーザー数50名程度、1日の注文量30件程度を想定

---

## 7. 今後の拡張可能性

### Phase 2
- 通知機能(メール、プッシュ通知)
- レポート機能(注文統計、利用状況)
- 二要素認証(2FA)
- セッション管理画面
- 注文履歴管理機能

### Phase 3
- モバイルアプリ
- ソーシャルログイン(Google OAuth)
- パスワードレス認証
- 外部システム連携

---

## 8. 想定ユーザー

### 一般ユーザー
- 社内メンバー
- 自分の弁当予約とチケット管理のみ

### 係
- 社内メンバー(係役割を持つ)
- 全ユーザーの予約確認・管理
- ゲスト予約作成
- チケット受取確認

### 管理者
- 社内メンバー(管理者役割を持つ)
- 係の全権限
- ユーザー管理(招待、無効化、役割変更)

---

**更新履歴:**
- 2025-11-30: 初版作成
- 2025-12-06: 詳細要件を追加(認証、チケット、注文、非機能要件)
- 2025-12-06: ユーザーフィードバックを反映(チケットUI、注文自動化、データ保持期間短縮)