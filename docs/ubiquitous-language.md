# ユビキタス言語 (Ubiquitous Language)

> このドキュメントは、Lunch-Hub システムにおいて開発者とドメインエキスパート（業務担当者）が共通で使用する用語を定義します。
> DDDでは、コード内のクラス名・メソッド名もこの用語に従って命名します。

---

## 📌 コアコンセプト

### 予約 (Reservation)
お弁当を注文するための予約。特定の日付に対して作成され、支払い方法を含む。

**属性:**
- 予約日 (Reservation Date)
- 予約者 (Reserver)
- 支払い方法 (Payment Method): 現金 or チケット
- 予約状態 (Reservation Status):
  - CONFIRMED（予約済み）: ユーザーにより予約が作成された状態。
  - CANCELLED（取消済み）: ユーザーまたは係により予約が取り消された状態。
  - FINALIZED（確定済み）: 9:30の締め切りを過ぎ、変更不可となった状態。
- 予約作成日時 (Created At)
- 最終更新日時 (Updated At)

**ビジネスルール:**
- 予約は当日9:30までに確定する必要がある
- 1ヶ月先まで予約可能
- 予約の変更・キャンセルは締め切り時刻まで可能

### 注文 (Order)
係の人がお弁当屋さんに実際に発注する単位。複数の予約をまとめたもの。

**属性:**
- 注文日 (Order Date)
- 注文リスト (Order Items): 予約の集合
- 注文総数 (Total Count)
- 注文状態 (Order Status): 未発注、発注済み

**ビジネスルール:**
- 注文は当日9:30以降に確定される
- 一度発注済みになった注文は変更不可

---

##  ユーザーエンティティ

### ユーザー (User)
システムにログインして弁当予約を行う社内メンバー。

**属性:**
- ユーザーID (User ID): システム内で一意の識別子、ログイン時の識別子としても使用可能
- 表示名 (Display Name): 実際の人名、画面に表示される名前（同姓同名可、例: `田中太郎`）
- メールアドレス (Email Address): 一意、ログイン時の識別子としても使用可能
- パスワード (Password): 認証に使用
- ロール (Role): 一般ユーザー、係、管理者のいずれか
- 作成日時 (Created At)
- 最終ログイン日時 (Last Login At)
- アクティブ状態 (Is Active): 有効/無効

**ビジネスルール:**
- ユーザーIDで一意に管理される
- メールアドレスは一意である必要がある
- 表示名は同姓同名が許可される
- ロールは1つのみ持つ（複数ロールは持たない）
- 無効化されたユーザーはログインできない
- 予約一覧などで同姓同名がいる場合、メールアドレスを併記して区別する（例: 「田中太郎 (tanaka@example.com)」）

**認証:**
- ユーザーはメールアドレスまたはユーザーIDとパスワードでログインする
- どちらの識別子を使用してもログイン可能（柔軟性とセキュリティの両立）
- ログインに成功すると、システムにアクセスできる
- ログアウトするまでセッションが維持される

---

## 👥 ユーザーロール

### 一般ユーザー (General User)
社内メンバーで、自分のお弁当を予約できるユーザー。

**権限:**
- 自分の予約を作成
- 自分の予約を変更
- 自分の予約をキャンセル
- 自分の予約を確認

### 係 (Staff / Coordinator)
お弁当の注文を取りまとめ、お弁当屋さんに発注する担当者。

**権限:**
- 一般ユーザーの全権限（**係自身も弁当予約・チケット購入が可能**）
- 全ユーザーの予約を確認
- 他ユーザーの予約を変更
- 他ユーザーの予約をキャンセル
- ゲスト用の予約を作成
- 注文を確定して発注

**注意:**
- 係も一般ユーザーと同様に自分の弁当を予約できる
- 係が複数人いる場合、それぞれが自分の予約と他ユーザーの予約を管理できる

### 管理者 (Administrator)
システム全体を管理する権限を持つユーザー。

**権限:**
- 係の全権限
- ユーザーの追加・削除
- ユーザーの権限変更
- 弁当・チケットの価格変更

### ゲスト (Guest)
社内メンバー以外の訪問者。係が代理で予約を作成する。

**特徴:**
- システムにログインしない
- 係が代理で予約を作成
- 名前のみで識別される

---

## 💳 支払い関連

### 支払い方法 (Payment Method)
予約時に選択する支払い手段。

**種類:**
- **現金払い (Cash Payment)**: 当日現金で支払う
- **チケット払い (Ticket Payment)**: 事前購入したチケットで支払う

### チケット (Ticket)
事前に購入する10枚綴りの食事券。

**属性:**
- チケット番号 (Ticket Number)
- 所有者 (Owner)
- 残り枚数 (Remaining Count): 0以上
- 購入日 (Purchase Date)
- 状態 (Status): 予約中、受取済み

**ビジネスルール:**
- 1チケットは10枚綴り
- 現金でのみ購入可能
- 弁当予約時に1枚消費される
- チケット購入予約をした時点で、そのチケットを使用可能（予約中状態）
- 実際にチケットを受け取ったら「受取済み」状態に変更

### チケット購入予約 (Ticket Purchase Reservation)
チケットを購入する予約。お弁当屋さんに事前に伝える必要がある。

**属性:**
- 購入予約日 (Purchase Date)
- 購入者 (Purchaser)
- 購入枚数 (Quantity): 通常1（10枚綴り1セット）
- 状態 (Status): 予約中、受取済み、キャンセル済み

**ビジネスルール:**
- チケット購入予約をすると、即座にチケットエンティティが「予約中」状態で作成される
- 予約中のチケットでも弁当予約に使用可能
- 弁当予約とチケット購入予約を同時に行うことが可能

---

## 📅 時間関連

### 予約期間 (Reservation Period)
予約可能な期間。現在から1ヶ月先まで。

### 注文締め切り時刻 (Order Deadline)
当日の9:30。この時刻を過ぎると予約の変更・キャンセルができない。

**ビジネスルール:**
- 締め切り前: 予約の作成・変更・キャンセルが可能
- 締め切り後: 予約の変更・キャンセルが不可

---

## 🔄 ビジネスプロセス

### 予約プロセス (Reservation Process)
1. ユーザーがカレンダーから日付を選択
2. 支払い方法（現金 or チケット）を選択
3. 予約を作成
4. 締め切り時刻までは変更・キャンセル可能

### 注文プロセス (Order Process)
1. 毎日9:30に注文締め切り
2. 係が予約一覧を確認
3. お弁当屋さんに電話で注文
4. 注文を「発注済み」に変更

### チケット購入プロセス (Ticket Purchase Process)
1. ユーザーがチケット購入予約を作成
2. システムが「予約中」状態のチケットエンティティを作成（残り枚数: 10）
3. **この時点で、予約中のチケットを使って弁当予約が可能**
4. 係が予約を確認
5. お弁当屋さんに電話でチケット購入を伝える
6. 当日、ユーザーが現金でチケットを購入
7. チケットの状態を「受取済み」に変更

### 弁当予約とチケット購入の同時予約プロセス
1. ユーザーがカレンダーから日付を選択
2. 「チケット購入 + チケット払いで弁当予約」を選択
3. システムが以下を同時に実行：
   - チケット購入予約を作成
   - 「予約中」状態のチケットを作成（残り枚数: 10）
   - そのチケットを使用して弁当予約を作成（残り枚数: 9に減少）
4. 締め切り時刻までは変更・キャンセル可能

---

## 🎯 重要な不変条件 (Invariants)

### 予約に関する不変条件
- 予約は必ず1つの日付に紐づく
- 予約は必ず1つの支払い方法を持つ
- 締め切り時刻を過ぎた予約は変更・キャンセル不可

### チケットに関する不変条件
- チケットの残り枚数は0以上（上限なし）
- チケット払いの予約時、チケットの残り枚数が1以上必要
- 弁当予約をキャンセルした場合、チケットの残り枚数が1増える
- チケット購入予約をすると、即座に「予約中」状態のチケットが作成される
- 予約中のチケットでも弁当予約に使用可能
- チケット購入予約をキャンセルした場合、そのチケットで使用した弁当予約も全てキャンセルされる

### 注文に関する不変条件
- 注文は必ず1つの日付に紐づく
- 発注済みの注文に含まれる予約は変更・キャンセル不可

---

## 📝 用語の使い分け

### 予約 vs 注文
- **予約 (Reservation)**: ユーザー視点。個人がお弁当を食べたいという意思表示
- **注文 (Order)**: 係視点。お弁当屋さんに実際に発注する単位（複数の予約をまとめたもの）

### ゲスト vs ユーザー
- **ゲスト (Guest)**: システムにログインしない訪問者
- **ユーザー (User)**: システムにログインできる社内メンバー

### 1.1 USERS（ユーザー関連）
- **ADMINISTRATOR（管理者）**: システム全般の管理、ユーザー招待を行う。
- **STAFF（係）**: 注文の集計、確定、ゲスト予約、チケット受取承認を行う。
- **GENERAL_USER（一般ユーザー）**: 自身の弁当予約、チケット購入予約を行う。
- **INVITED（招待中）**: 招待されたがアクティベーション未完了。
- **ACTIVE（有効）**: 通常利用可能。
- **DEACTIVATED（無効）**: 退職等によりログイン不可。

### キャンセル vs 削除
- **アクセスコード / PIN (Company PIN)**: 社員であることを証明するための共有パスコード。セルフサインアップ時に使用。
- **サインアップ (Sign up)**: ユーザーが自らアカウント作成を申請すること。
- **削除 (Delete)**: データを完全に削除すること（基本的に使用しない）

---

## 🔍 補足説明

このユビキタス言語は、プロジェクトの進行に伴って更新・拡張されます。
新しい概念が発見された場合や、用語の定義が曖昧な場合は、このドキュメントを更新してチーム全体で共有します。

**更新履歴:**
- 2025-11-30: 初版作成
