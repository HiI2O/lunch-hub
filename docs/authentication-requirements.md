# 認証機能 要件定義

## 概要
Lunch Hubアプリケーションに招待制の認証システムを実装し、社内ユーザーのみがアクセスできるようにする。

## 目的
- 個人のクラウドサーバにデプロイされたアプリケーションへのアクセスを社内ユーザーに限定する
- セキュアで使いやすい認証・認可の仕組みを提供する
- ユーザー自身がパスワードを管理できるようにする

## 機能要件

### 1. ユーザー招待機能
- **管理者によるユーザー招待**
  - 管理者がメールアドレスを指定してユーザーを招待できる
  - 招待時にユーザーの役割(Role)を指定できる
  - 招待メールに有効期限付きの招待リンクを含める
  - 招待リンクの有効期限は48時間とする

- **招待状態の管理**
  - 招待済み・未アクティベート状態を管理
  - 招待の取り消し機能
  - 招待の再送信機能

### 2. 初回登録機能
- **アカウントアクティベーション**
  - 招待リンクからアクセスし、初回パスワードを設定
  - パスワードポリシーの適用(最低8文字、英数字記号を含む)
  - アクティベーション完了後、即座にログイン可能

### 3. ログイン・ログアウト機能
- **ログイン**
  - メールアドレスとパスワードによる認証
  - ログイン失敗時のエラーメッセージ(セキュリティ考慮)
  - ログイン試行回数の制限(5回/15分)
  - セッション管理(JWT使用)

- **ログアウト**
  - セッションの無効化
  - リフレッシュトークンの削除

### 4. パスワード管理機能
- **パスワード変更**
  - ログイン後、現在のパスワードを入力して新しいパスワードに変更
  - パスワードポリシーの適用

- **パスワードリセット**
  - パスワードを忘れた場合のリセット機能
  - メールアドレスを入力してリセットリンクを送信
  - リセットリンクの有効期限は1時間
  - リセット完了後、全セッションを無効化

### 5. セッション管理
- **トークンベースの認証**
  - アクセストークン(有効期限: 15分)
  - リフレッシュトークン(有効期限: 7日)
  - トークンの自動更新

- **セッションの無効化**
  - パスワード変更時に全セッションを無効化
  - 管理者による強制ログアウト

### 6. 役割ベースのアクセス制御(RBAC)
- **役割の定義**
  - `ADMIN`: 管理者(ユーザー招待、全機能へのアクセス)
  - `EMPLOYEE`: 一般従業員(注文機能へのアクセス)

- **権限の管理**
  - 役割に基づいた機能へのアクセス制御
  - APIエンドポイントレベルでの認可チェック

## 非機能要件

### セキュリティ
- パスワードはbcryptでハッシュ化(cost factor: 12)
- 全ての認証関連通信はHTTPS必須
- トークンはHTTP-only cookieで管理
- CSRF対策の実装
- レート制限の実装

### パフォーマンス
- ログイン処理は2秒以内に完了
- トークン検証は100ms以内に完了

### 可用性
- 認証サービスの可用性: 99.9%以上

### 監査
- ログイン試行(成功・失敗)のログ記録
- パスワード変更のログ記録
- 招待・アクティベーションのログ記録

## 制約事項
- メール送信機能が必要(SMTP設定またはメール送信サービス)
- 初期管理者アカウントはシードデータで作成
- 同一メールアドレスでの重複登録は不可

## 今後の拡張可能性
- 二要素認証(2FA)の追加
- ソーシャルログイン(Google OAuth等)の追加
- パスワードレス認証の検討
- セッション管理画面(アクティブなセッション一覧、個別無効化)
