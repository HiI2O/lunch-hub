---
description: 要件を再確認し、リスクを評価し、ステップバイステップの実装計画を作成。コードに触れる前にユーザーの確認を待つ。
---

# Planコマンド

このコマンドは **planner** エージェントを呼び出して、コードを書く前に包括的な実装計画を作成します。

## このコマンドの機能

1. **要件の再確認** - 何を構築するか明確化
2. **リスクの特定** - 潜在的な問題とブロッカーを表面化
3. **ステップ計画の作成** - 実装をフェーズに分解
4. **確認を待機** - 進行する前にユーザーの承認を得る必須

## 使用タイミング

以下の場合に `/plan` を使用:
- 新機能を開始する
- 重要なアーキテクチャ変更を行う
- 複雑なリファクタリングに取り組む
- 複数のファイル/コンポーネントが影響を受ける
- 要件が不明確または曖昧

## 動作方法

plannerエージェントは以下を行います：

1. **リクエストを分析**して要件を明確な用語で再確認
2. **フェーズに分解**して具体的で実行可能なステップを作成
3. コンポーネント間の**依存関係を特定**
4. **リスクを評価**して潜在的なブロッカーを特定
5. **複雑度を見積もり**（高/中/低）
6. **計画を提示**して明示的な確認を待つ

## 使用例

```
ユーザー: /plan マーケットが解決した時のリアルタイム通知を追加したい

エージェント (planner):
# 実装計画: リアルタイムマーケット解決通知

## 要件の再確認
- ユーザーがウォッチしているマーケットが解決した時に通知を送信
- 複数の通知チャネルをサポート（アプリ内、メール、webhook）
- 通知が確実に配信されることを保証
- マーケットの結果とユーザーのポジション結果を含める

## 実装フェーズ

### フェーズ1: データベーススキーマ
- notificationsテーブルを追加（カラム: id, user_id, market_id, type, status, created_at）
- チャネル設定用のuser_notification_preferencesテーブルを追加
- パフォーマンスのためuser_idとmarket_idにインデックスを作成

### フェーズ2: 通知サービス
- lib/notifications.tsに通知サービスを作成
- BullMQ/Redisを使用した通知キューを実装
- 配信失敗のリトライロジックを追加
- 通知テンプレートを作成

### フェーズ3: 統合ポイント
- マーケット解決ロジックにフック（ステータスが"resolved"に変更時）
- マーケットにポジションを持つ全ユーザーをクエリ
- 各ユーザー用の通知をキューに追加

### フェーズ4: フロントエンドコンポーネント
- ヘッダーにNotificationBellコンポーネントを作成
- NotificationListモーダルを追加
- Supabase subscriptionsでリアルタイム更新を実装
- 通知設定ページを追加

## 依存関係
- Redis（キュー用）
- メールサービス（SendGrid/Resend）
- Supabaseリアルタイムsubscriptions

## リスク
- HIGH: メール配信性（SPF/DKIMが必要）
- MEDIUM: 1000人以上のユーザーがいるマーケットでのパフォーマンス
- MEDIUM: マーケットが頻繁に解決する場合の通知スパム
- LOW: リアルタイムsubscriptionのオーバーヘッド

## 推定複雑度: MEDIUM

**確認待ち**: この計画で進めますか？（yes/no/modify）
```

## 重要な注意事項

**CRITICAL**: plannerエージェントは、明示的に"yes"、"proceed"、または類似の肯定的な応答で計画を確認するまで、**コードを書きません**。

変更を希望する場合は、以下のように応答:
- "modify: [変更内容]"
- "different approach: [代替案]"
- "skip phase 2 and do phase 3 first"

## 他のコマンドとの統合

計画後:
- テスト駆動開発で実装するには `/tdd` を使用
- ビルドエラーが発生した場合は `/build-and-fix` を使用
- 完成した実装をレビューするには `/code-review` を使用

## 関連エージェント

このコマンドは以下にある `planner` エージェントを呼び出します：
`~/.claude/agents/planner.md`
